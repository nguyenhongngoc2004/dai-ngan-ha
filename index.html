<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Spiral Galaxy 9 Planets</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<style>
body { margin:0; overflow:hidden; background:black; }
#gestureNote {
  position:absolute; bottom:20px; left:20px;
  padding:10px 14px; background:rgba(0,0,0,0.45);
  color:#fff; font-family:system-ui,-apple-system,BlinkMacSystemFont;
  font-size:14px; border-radius:12px;
  backdrop-filter:blur(6px); pointer-events:none;
  box-shadow:0 0 12px rgba(255,255,255,0.15);
}
#handCanvas {
  position:absolute;
  bottom:20px;
  right:20px;
  width:160px;
  height:120px;
  border-radius:12px;
  opacity:0.75;
  pointer-events:none;
  z-index:10;
}
</style>
</head>
<body>
<div id="gestureNote"></div>
<video id="video" style="display:none;"></video>
<canvas id="handCanvas" width="160" height="120"></canvas>

<script>
// ================= THREE.JS SETUP =================
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff,0.25));

const galaxy = new THREE.Group();
scene.add(galaxy);

// Sun
const sun = new THREE.Mesh(
  new THREE.SphereGeometry(6,64,64),
  new THREE.MeshPhysicalMaterial({color:0xffee88, emissive:0xffcc66, emissiveIntensity:1.5, roughness:0.4})
);
galaxy.add(sun);

// ================= PLANETS =================
const planets = [];
function createPlanet(radius, dist, speed, options={}) {
  const pivot = new THREE.Object3D();
  pivot.userData.speed = speed;

  const mat = new THREE.MeshPhysicalMaterial({
    color: options.color ?? 0xffffff,
    roughness: options.roughness ?? 0.5,
    metalness: options.metalness ?? 0.1,
    emissive: options.emissive ?? 0x000000,
    emissiveIntensity: options.emissiveIntensity ?? 0.05,
    clearcoat: options.clearcoat ?? 0.2
  });

  const planet = new THREE.Mesh(new THREE.SphereGeometry(radius,64,64), mat);
  pivot.userData.planet = planet;
  planet.position.x = dist;
  pivot.add(planet);

  // Atmosphere
  if(options.atmosphere){
    const atmo = new THREE.Mesh(
      new THREE.SphereGeometry(radius*1.05,64,64),
      new THREE.MeshBasicMaterial({color: options.atmosphere, transparent:true, opacity:0.15, blending:THREE.AdditiveBlending})
    );
    planet.add(atmo);
  }

  // Ring
  if(options.ring){
    const ring = new THREE.Mesh(
      new THREE.RingGeometry(radius*1.4, radius*2.2,64),
      new THREE.MeshBasicMaterial({color:options.ring, transparent:true, opacity:0.5, side:THREE.DoubleSide})
    );
    ring.rotation.x = Math.PI/2;
    planet.add(ring);
  }

  galaxy.add(pivot);
  planets.push(pivot);
  return pivot;
}

// T·∫°o 9 h√†nh tinh tr√™n 9 v√≤ng
const planetColors = [0xaaaaaa,0xffcc88,0x2266ff,0xff5533,0xffaa55,0xffe0aa,0x88ccff,0xaaff88,0xff88ff];
for(let i=0;i<9;i++){
  createPlanet(2 + i*0.1, 10 + i*6, 0.01 + i*0.002, {color:planetColors[i]});
}

// ================= SPIRAL GALAXY =================
function createSpiralGalaxy(){
  const spiralArms = 9;
  const starsPerArm = 3000;
  const positions=[], colors=[];

  for(let arm=0; arm<spiralArms; arm++){
    const radiusBase = 10 + arm*6;
    for(let i=0; i<starsPerArm; i++){
      const t = i/starsPerArm;
      const angle = t*6*Math.PI + arm*(2*Math.PI/spiralArms); // xo·∫Øn nhi·ªÅu v√≤ng
      const radius = radiusBase + Math.random()*1.5; // nhi·ªÖu nh·∫π
      const x = Math.cos(angle)*radius;
      const z = Math.sin(angle)*radius;
      const y = (Math.random()-0.5)*0.3;
      positions.push(x,y,z);

      const c = new THREE.Color();
      c.r = 1*(1-t) + 0.5*t;
      c.g = 0.85*(1-t)+0.8*t;
      c.b = 0.5*(1-t)+1*t;
      colors.push(c.r,c.g,c.b);
    }
  }

  const geo = new THREE.BufferGeometry();
  geo.setAttribute('position', new THREE.Float32BufferAttribute(positions,3));
  geo.setAttribute('color', new THREE.Float32BufferAttribute(colors,3));

  const mat = new THREE.PointsMaterial({
    size:0.15, map:createStarTexture(), transparent:true, opacity:0.9,
    vertexColors:true, blending:THREE.AdditiveBlending, depthWrite:false, sizeAttenuation:true
  });

  const spiral = new THREE.Points(geo, mat);
  galaxy.add(spiral);
}
function createStarTexture(){
  const size = 128;
  const canvas = document.createElement("canvas");
  canvas.width = canvas.height = size;
  const ctx = canvas.getContext("2d");
  const grad = ctx.createRadialGradient(size/2,size/2,0,size/2,size/2,size/2);
  grad.addColorStop(0,"rgba(255,255,255,1)");
  grad.addColorStop(0.4,"rgba(255,255,255,0.6)");
  grad.addColorStop(1,"rgba(255,255,255,0)");
  ctx.fillStyle = grad; ctx.fillRect(0,0,size,size);
  return new THREE.CanvasTexture(canvas);
}
createSpiralGalaxy();

// ================= HAND TRACKING =================
const videoEl=document.getElementById("video");
const canvasEl=document.getElementById("handCanvas");
const ctx2=canvasEl.getContext("2d");
let state="ROTATE", lastState="ROTATE", smoothState="ROTATE";
const noteEl=document.getElementById("gestureNote");
const stateText={
  ROTATE:"‚úã Xoay tay: Chuy·ªÉn h√†nh tinh",
  TREE:"‚úä Bung tay: Zoom ra to√†n c·∫£nh",
  PHOTO:"ü§è N·∫Øm tay: Zoom v√†o h√†nh tinh"
};

const hands=new Hands({locateFile:file=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({maxNumHands:2, modelComplexity:1, minDetectionConfidence:0.7, minTrackingConfidence:0.7});

hands.onResults(results=>{
  ctx2.clearRect(0,0,canvasEl.width,canvasEl.height);
  if(results.image) ctx2.drawImage(results.image,0,0,canvasEl.width,canvasEl.height);
  if(!results.multiHandLandmarks || results.multiHandLandmarks.length===0) return;

  const lm = results.multiHandLandmarks[0];
  const wrist = lm[0];
  const tips=[8,12,16,20];
  let open=0;
  tips.forEach(i=>open+=Math.hypot(lm[i].x-wrist.x,lm[i].y-wrist.y));
  const avgOpen = open/tips.length;

  let newState=lastState;
  if(avgOpen<0.18) newState="PHOTO";
  else if(avgOpen>0.28) newState="TREE";
  else newState="ROTATE";

  if(newState!==lastState){
    if(newState==="ROTATE" && lastState!=="ROTATE"){
      currentPlanetIndex++;
      if(currentPlanetIndex>=planets.length) currentPlanetIndex=0;
      moveToPlanet(currentPlanetIndex);
    }
    state=newState; lastState=newState;
  }
});

function moveToPlanet(index){
  if(index<0) index=planets.length-1;
  if(index>=planets.length) index=0;
  currentPlanetIndex=index;

  const planetPos=new THREE.Vector3();
  planets[currentPlanetIndex].userData.planet.getWorldPosition(planetPos);
  targetCameraPos.copy(planetPos).add(new THREE.Vector3(0,4,12));
}

const cameraMP=new Camera(videoEl,{onFrame:async()=>{await hands.send({image:videoEl});},width:640,height:480});
cameraMP.start();

// ================= ANIMATE =================
const initialCameraPos = new THREE.Vector3(0,50,150);
const galaxyViewCameraPos = new THREE.Vector3(0,100,200);
camera.position.copy(initialCameraPos);
const lookTarget = new THREE.Vector3(0,0,0);
camera.lookAt(lookTarget);
let targetCameraPos = initialCameraPos.clone();
let currentPlanetIndex = 0;

function animate(){
  requestAnimationFrame(animate);
  sun.rotation.y+=0.003;

  planets.forEach(p=>{
    p.rotation.y += p.userData.speed;
    const targetScale = state==="PHOTO"?3:1;
    p.scale.lerp(new THREE.Vector3(targetScale,targetScale,targetScale),0.1);
  });

  if(state==="PHOTO"){
    planets[currentPlanetIndex].userData.planet.getWorldPosition(lookTarget);
    camera.position.lerp(targetCameraPos,0.05);
  } else if(state==="TREE"){
    lookTarget.set(0,0,0);
    camera.position.lerp(galaxyViewCameraPos,0.05);
  } else {
    lookTarget.set(0,0,0);
    camera.position.lerp(initialCameraPos,0.05);
  }

  camera.lookAt(lookTarget);
  smoothState = state;
  galaxy.scale.lerp(new THREE.Vector3(1,1,1),0.05);
  noteEl.textContent = stateText[smoothState]||"";

  renderer.render(scene,camera);
}
animate();

window.addEventListener("resize", ()=>{
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>
</body>
</html>