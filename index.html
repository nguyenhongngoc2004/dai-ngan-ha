<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Universe + Solar System</title>
<style>
body { margin:0; overflow:hidden; background:black; }
</style>
</head>

<body>
<script type="module">
import * as THREE from "https://cdn.skypack.dev/three@0.136.0";
import { OrbitControls } from "https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls";

/// ================= SCENE =================
const scene = new THREE.Scene();
scene.background = new THREE.Color('#160016');

function createSpaceBackground(){
  const count = 6000;
  const positions = [];
  const colors = [];

  for(let i = 0; i < count; i++){
    const r = 320;

    const theta = Math.random() * Math.PI * 2;
    const phi = Math.acos(2 * Math.random() - 1);

    const x = r * Math.sin(phi) * Math.cos(theta);
    const y = r * Math.sin(phi) * Math.sin(theta);
    const z = r * Math.cos(phi);

    positions.push(x, y, z);

    const c = new THREE.Color().setHSL(
      0.6 + Math.random() * 0.12, // xanhâ€“tÃ­m galaxy
      0.45,
      0.65 + Math.random() * 0.25
    );
    colors.push(c.r, c.g, c.b);
  }

  const geo = new THREE.BufferGeometry();
  geo.setAttribute("position", new THREE.Float32BufferAttribute(positions, 3));
  geo.setAttribute("color", new THREE.Float32BufferAttribute(colors, 3));

  const mat = new THREE.PointsMaterial({
    size: 0.75,
    vertexColors: true,
    transparent: true,
    opacity: 0.85,
    depthWrite: false
  });

  const stars = new THREE.Points(geo, mat);
  scene.add(stars);
}

const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 1, 1000);
camera.position.set(0, 18, 36);
camera.lookAt(0, 0, 0);

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
document.body.appendChild(renderer.domElement);

renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 0.9;

window.addEventListener("resize", ()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

createSpaceBackground();

/// ================= CONTROLS =================
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.enablePan = false;

/// ================= SOLAR SYSTEM =================
const solar = new THREE.Group();
scene.add(solar);

const sunLight = new THREE.PointLight(
  new THREE.Color(1.0, 0.9, 0.7),
  1.8,
  300
);
solar.add(sunLight);

function addSunSpot(){
  const spot = new THREE.Mesh(
    new THREE.CircleGeometry(0.16, 32),
    new THREE.MeshBasicMaterial({
      color: 0x442200,
      transparent: true,
      opacity: 0.28
    })
  );

  const phi = Math.random() * Math.PI;
  const theta = Math.random() * Math.PI * 2;
  const r = 2.601;

  spot.position.set(
    r * Math.sin(phi) * Math.cos(theta),
    r * Math.cos(phi),
    r * Math.sin(phi) * Math.sin(theta)
  );

  spot.lookAt(0,0,0);
  sun.add(spot);
}

// táº¡o 6â€“8 sunspot
for(let i=0;i<5;i++) addSunSpot();

function generatePlanetNoise(seed, size = 256, repeat = 4){
  const canvas = document.createElement("canvas");
  canvas.width = canvas.height = size;
  const ctx = canvas.getContext("2d");

  const img = ctx.createImageData(size, size);
  let rand = seed;

  function random(){
    rand = (rand * 9301 + 49297) % 233280;
    return rand / 233280;
  }

  for(let i=0;i<img.data.length;i+=4){
    const v = random() * 255;
    img.data[i] = v;
    img.data[i+1] = v;
    img.data[i+2] = v;
    img.data[i+3] = 255;
  }

  ctx.putImageData(img,0,0);

  const tex = new THREE.CanvasTexture(canvas);
  tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
  tex.repeat.set(repeat, repeat);

  return tex;
}

function generateSunSpotTexture(size = 512, spotCount = 12){
  const canvas = document.createElement("canvas");
  canvas.width = canvas.height = size;
  const ctx = canvas.getContext("2d");

  // ná»n xÃ¡m (khÃ´ng tráº¯ng)
  ctx.fillStyle = "rgb(180,180,180)";
  ctx.fillRect(0,0,size,size);

  for(let i=0;i<spotCount;i++){
    const x = Math.random() * size;
    const y = Math.random() * size;
    const r = size * (0.04 + Math.random()*0.08);

    const g = ctx.createRadialGradient(x,y,0,x,y,r);
    g.addColorStop(0,"rgba(40,40,40,0.85)");
    g.addColorStop(0.4,"rgba(60,60,60,0.5)");
    g.addColorStop(1,"rgba(180,180,180,0)");

    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fill();
  }

  const tex = new THREE.CanvasTexture(canvas);
  tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
  tex.repeat.set(1.5,1.5);

  return tex;
}

const sunSpotTex = generateSunSpotTexture(512, 14);

scene.add(new THREE.AmbientLight(0x1a1a1a));

const planets = [];
const galaxyColors = [
  new THREE.Color(0xffffff), // tráº¯ng
  new THREE.Color(0xe6ddff), // tÃ­m ráº¥t nháº¡t
  new THREE.Color(0xcad8ff), // xanh lam nháº¡t
];

function createStarRing(radius, count = 1800){
  const pos = [];
  const colors = [];

  const palette = [
    new THREE.Color("#ffffff"),
    new THREE.Color("#e6ddff"),
    new THREE.Color("#cad8ff")
  ];

  for(let i=0;i<count;i++){
    const a = Math.random() * Math.PI * 2;
    const r = radius + (Math.random()-0.5) * 1.3;

    pos.push(
      Math.cos(a)*r,
      (Math.random()-0.5)*0.3, // ráº¥t má»ng
      Math.sin(a)*r
    );

    const c = palette[Math.floor(Math.random()*palette.length)];
    colors.push(c.r,c.g,c.b);
  }

  const geo = new THREE.BufferGeometry();
  geo.setAttribute("position", new THREE.Float32BufferAttribute(pos,3));
  geo.setAttribute("color", new THREE.Float32BufferAttribute(colors,3));

  const mat = new THREE.PointsMaterial({
    size: 0.08,
    vertexColors: true,
    transparent: true,
    opacity: 0.38,
    blending: THREE.AdditiveBlending,
    depthWrite: false
  });

  return new THREE.Points(geo, mat);
}

function generateSunTexture(size = 512){
  const canvas = document.createElement("canvas");
  canvas.width = canvas.height = size;
  const ctx = canvas.getContext("2d");

  const grd = ctx.createRadialGradient(
    size/2, size/2, size*0.15,
    size/2, size/2, size*0.5
  );

  grd.addColorStop(0, "#fff7cc");   // lÃµi tráº¯ng vÃ ng
  grd.addColorStop(0.4, "#ffcc66"); // vÃ ng
  grd.addColorStop(0.75, "#ff9933");// cam
  grd.addColorStop(1, "#cc6600");   // rÃ¬a tá»‘i

  ctx.fillStyle = grd;
  ctx.fillRect(0,0,size,size);

  const tex = new THREE.CanvasTexture(canvas);
  tex.minFilter = THREE.LinearFilter;
  tex.magFilter = THREE.LinearFilter;
  tex.colorSpace = THREE.SRGBColorSpace;

  return tex;
}

function addPlanet(size, dist, speed, color, type = "rock"){

  const pivot = new THREE.Object3D();

  // ===== MATERIAL THEO TYPE =====
  let planetMaterial;

  if(type === "rock"){
    planetMaterial = new THREE.MeshStandardMaterial({
      color,
      roughness: 0.85,
      metalness: 0.05,
    });
  }

  if(type === "ice"){
    planetMaterial = new THREE.MeshStandardMaterial({
      color,
      roughness: 0.55,
      metalness: 0.1,
      normalMap: generatePlanetNoise(Math.random()*9999, 256, 6),
      normalScale: new THREE.Vector2(0.35, 0.35)
    });
  }

  if(type === "gas"){
    planetMaterial = new THREE.MeshStandardMaterial({
      color,
      roughness: 0.35,
      metalness: 0.0,
      emissive: new THREE.Color(color),
      emissiveIntensity: 0.25
    });
  }

  // ===== MESH =====
  const mesh = new THREE.Mesh(
    new THREE.SphereGeometry(size, 64, 64),
    planetMaterial
  );
  pivot.add(mesh);

  // ðŸŒŸ VÃ’NG SAO
  const ring = createStarRing(dist);
  pivot.add(ring);

  // ====== ELIP DATA ======
  pivot.userData = {
    speed,
    angle: Math.random() * Math.PI * 2,
    a: dist * (1 + Math.random()*0.25),
    b: dist * (0.75 + Math.random()*0.2),
  };

  solar.add(pivot);
  planets.push(pivot);
}

/// 7 hÃ nh tinh
addPlanet(0.38, 4, 0.003, 0xaaaaaa, "rock"); // Mercury
addPlanet(0.95, 6, 0.0025, 0xffcc88, "rock"); // Venus
addPlanet(1.0,  8, 0.002,  0x2a5cff, "ice");  // Earth
addPlanet(0.53,10, 0.0018, 0xff5533, "rock"); // Mars

addPlanet(3.6, 14, 0.0012, 0xffaa55, "gas"); // Jupiter
addPlanet(3.0, 18, 0.001,  0xffe0aa, "gas"); // Saturn
addPlanet(2.1, 22, 0.0007, 0x88ccff, "ice"); // Uranus
addPlanet(2.0, 26, 0.0005, 0x4466ff, "ice"); // Neptune

/// ================= ANIMATE =================
const clock = new THREE.Clock();

renderer.setAnimationLoop(() => {

  const elapsed = clock.getElapsedTime();

  // ðŸª HÃ€NH TINH + VÃ’NG SAO
  planets.forEach(p => {
    p.userData.angle += p.userData.speed;

    const a = p.userData.a;
    const b = p.userData.b;
    const t = p.userData.angle;

    const x = Math.cos(t) * a;
    const z = Math.sin(t) * b;

    p.children.forEach(obj => {
      if (obj.isMesh) {
        obj.position.set(x, 0, z);
      }

      if (obj.isPoints) {
        obj.rotation.y += p.userData.speed * 0.1;
        obj.material.opacity =
          0.45 + Math.sin(elapsed * 0.6) * 0.1;
      }
    });
  });

  controls.update();
  renderer.render(scene, camera);
});

</script>
</body>
</html>